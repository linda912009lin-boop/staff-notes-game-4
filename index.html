<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<!-- å›ºå®šå¯¬åº¦ 1200ï¼šæ‰€æœ‰è£ç½®éƒ½ä»¥ç›¸åŒç‰ˆé¢å‘ˆç¾ -->
<meta name="viewport" content="width=1200, initial-scale=1, viewport-fit=cover"/>
<title>éŸ³ç¬¦æ¶ˆæ¶ˆæ¨‚ï¼ˆå›ºå®šç‰ˆé¢ + æ’è¡Œæ¦œï¼‰</title>
<style>
  :root{
    --bg:#fff; --text:#222; --muted:#666; --border:#ddd; --panel:#f8f8f8;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:"Microsoft JhengHei","PingFang TC",system-ui,sans-serif}

  /* ---- å›ºå®š 1200px ç‰ˆé¢ï¼šæ‰€æœ‰å€å¡Šå¯¬åº¦ä¸€è‡´ ---- */
  header, main, footer, .creditbar{width:1200px; margin:0 auto;}

  header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--border)}
  .wrap{
    width:1200px;margin:0 auto;padding:12px 14px 8px;
    display:grid;grid-template-columns:1fr auto auto;grid-template-rows:auto auto;gap:6px 12px;align-items:center
  }
  .title{grid-column:1/2;grid-row:1/2;font-weight:900;font-size:32px}
  .minirow{grid-column:1/2;grid-row:2/3;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .rightTop{grid-column:3/4;grid-row:1/3;display:flex;gap:8px;align-items:center;justify-content:flex-end;flex-wrap:wrap}
  .group{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:6px 8px;display:flex;align-items:center;gap:8px}
  .group.compact{transform-origin:left center;font-size:12px}
  .group.smalltext{font-size:12px}
  button,input[type="range"]{border:1px solid var(--border);background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer;font-size:12px}

  /* ---- éŠæˆ²å€å›ºå®š 9 æ¬„ã€å›ºå®šå¡ç‰Œå°ºå¯¸ ---- */
  #game-board{
    display:grid;
    grid-template-columns: repeat(9, 120px);
    grid-auto-rows: 180px;
    gap:10px;
    width:1200px;
    margin:10px auto 20px;
    justify-content:center; /* è®“ 9 æ¬„å±…ä¸­ */
  }
  .card{
    position:relative;width:120px;height:180px;
    border:1px solid var(--border);border-radius:10px;background:#fff;
    box-shadow:0 2px 6px rgba(0,0,0,.08);
    cursor:pointer;display:grid;place-items:center;overflow:hidden
  }
  .card img{max-width:100%;max-height:100%;object-fit:contain;pointer-events:none}
  .badge{position:absolute;top:6px;left:6px;font-size:11px;padding:2px 6px;border-radius:999px}
  .badge.staff{background:#cfe8ff;color:#06407a} .badge.name{background:#d8f5e8;color:#0f4a2f} .badge.solfege{background:#fff3cd;color:#7a5c00}
  .selected{outline:3px solid #3b82f6; outline-offset:-3px}
  .hidden{visibility:hidden}

  /* æç¤ºä»¥ã€Œæ¡†æ¡†é–ƒçˆã€å‘ˆç¾ï¼ˆéç·šæ¢ï¼‰ */
  .hint{animation:pulse 1s infinite; box-shadow:0 0 0 3px rgba(255,153,0,.65) inset, 0 0 0 3px rgba(255,153,0,.65)}
  @keyframes pulse{
    0%{box-shadow:0 0 0 0 rgba(255,153,0,0) inset, 0 0 0 0 rgba(255,153,0,0)}
    50%{box-shadow:0 0 0 6px rgba(255,153,0,.65) inset, 0 0 0 6px rgba(255,153,0,.65)}
    100%{box-shadow:0 0 0 0 rgba(255,153,0,0) inset, 0 0 0 0 rgba(255,153,0,0)}
  }

  footer{position:static;background:#fff;border-top:1px solid var(--border);margin-top:20px}
  .foot{width:1200px;margin:0 auto;padding:8px 14px;display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:12px;gap:10px;flex-wrap:wrap}

  .creditbar{position:static;background:#fafafa;border-top:1px solid #eee;color:#777;font-size:12px;text-align:center;padding:8px 8px 12px}
  .creditbar a{color:#667; text-decoration:underline}

  dialog{border:none;border-radius:12px;max-width:760px;width:760px;background:#fff;box-shadow:0 24px 80px rgba(0,0,0,.25)}
  .dlg-head{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-bottom:1px solid var(--border)}
  .dlg-body{padding:14px;line-height:1.6;max-height:65vh;overflow:auto}
  .dlg-actions{display:flex;justify-content:flex-end;gap:8px;padding:0 14px 14px}
  .mode-pill{background:#eef;border:1px solid #cfe;font-size:12px;padding:4px 8px;border-radius:999px;margin-left:8px}

  .toast{position:fixed;top:70px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:8px 12px;border-radius:999px;font-size:12px;opacity:.9;display:none;z-index:50}

  .modeBtn{border:2px solid #cfd7ff}
  .modeBtn.active{border:2px solid #3b82f6; background:#eef5ff}

  /* å·²ç§»é™¤æ‰€æœ‰ RWD @mediaï¼Œç¢ºä¿åœ¨å„è£ç½®å¤–è§€ä¸€è‡´ */
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title"><span id="titleText">éŸ³ç¬¦æ¶ˆæ¶ˆæ¨‚ï¼ˆç°¡å–®ç‰ˆï¼‰</span> <span id="modePill" class="mode-pill">ç°¡å–®</span></div>
      <div class="minirow">
        <div class="group compact">
          <span>BGM</span><input id="volBgm" type="range" min="0" max="1" step="0.01" value="0.5">
          <span>âœ”</span><input id="volOk" type="range" min="0" max="1" step="0.01" value="0.8">
          <span>âœ–</span><input id="volNg" type="range" min="0" max="1" step="0.01" value="0.8">
        </div>
        <div class="group smalltext"><button id="btnHowTo">éŠæˆ²ç©æ³•</button></div>
        <div class="group smalltext"><button id="btnLeaderboard">æ’è¡Œæ¦œ</button></div>
        <div class="group smalltext"><button id="btnRestart">é‡æ–°é–‹å§‹</button></div>
      </div>
      <div class="rightTop">
        <div class="group smalltext">åˆ†æ•¸ <b id="score">0</b></div>
        <div class="group smalltext">æ™‚é–“ <b id="time">00:00</b></div>
      </div>
    </div>
  </header>

  <main><div id="game-board"></div></main>

  <footer>
    <div class="foot">
      <div>ä¸€æ¬¡éœ€é¸ <b>ä¸‰å¼µ</b>ï¼ˆåŒéŸ³é«˜ï¼šäº”ç·šè­œ + éŸ³å + å”±åï¼‰ã€‚æ¯çµ„ +5 åˆ†ã€‚</div>
      <div>30 ç§’ç„¡è§£ â†’ è‡ªå‹•äº®å‡ºå¯æ¶ˆçµ„åˆï¼›å¯éš¨æ™‚é»ã€ŒéŠæˆ²ç©æ³•ã€ã€‚</div>
    </div>
  </footer>

  <div class="creditbar">
    éŠæˆ²éŸ³æ¨‚ä¾†æºï¼š â€œBittersweetâ€ Kevin MacLeod (<a href="https://incompetech.com" target="_blank">incompetech.com</a>) Â·
    Licensed under <a href="http://creativecommons.org/licenses/by/4.0/" target="_blank">CC BY 4.0</a>
  </div>

  <div id="toast" class="toast">å¡å¡äº†å—ï¼Ÿå¹«ä½ äº®å‡ºä¸€çµ„å¯ä»¥æ¶ˆçš„ç‰Œï¼</div>

  <!-- éŠæˆ²è§£èªªèˆ‡æ¨¡å¼é¸æ“‡ -->
  <dialog id="dlgHow">
    <div class="dlg-head"><div>éŠæˆ²è§£èªª</div></div>
    <div class="dlg-body">
      <p><b>é¸æ“‡æ¨¡å¼ï¼š</b></p>
      <div style="display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap;">
        <button id="startEasy" class="modeBtn">ç°¡å–®ç‰ˆ</button>
        <button id="startHard" class="modeBtn">å›°é›£ç‰ˆ</button>
      </div>
      <p id="selectStatus" style="color:#3b82f6; font-weight:700; display:none;">å·²é¸æ“‡ï¼šâ€”</p>
      <p><b>è¦å‰‡ï¼š</b>è«‹æ‰¾å‡ºåŒéŸ³é«˜çš„ä¸‰å¼µå¡ç‰Œï¼ˆ<b>äº”ç·šè­œ + éŸ³å + å”±å</b>ï¼‰å³å¯æ¶ˆé™¤ï¼Œä¸¦ä¸”èƒ½ç²å¾— <b>5 åˆ†</b>ã€‚</p>
      <p><b>æç¤ºï¼š</b>è‹¥ <b>30 ç§’</b>é‚„æœªæ¶ˆé™¤å¡ç‰Œï¼Œç³»çµ±æœƒè‡ªå‹•é–ƒçˆä¸€çµ„å¯æ¶ˆé™¤çš„ç‰Œï¼Œå”åŠ©ä½ å®ŒæˆéŠæˆ²ä»»å‹™ã€‚</p>
    </div>
    <div class="dlg-actions"><button id="dlgStartClose" disabled>éŠæˆ²é–‹å§‹</button></div>
  </dialog>

  <!-- éé—œçµç®— -->
  <dialog id="dlgResult">
    <div class="dlg-head"><div>çµæœ</div></div>
    <div class="dlg-body">
      <h3>ğŸ‰ æ­å–œéé—œï¼</h3>
      <p>æˆç¸¾åˆ†æ•¸ï¼š<b id="finalScore">0</b></p>
      <p>éŠæˆ²æ™‚é–“ï¼š<b id="finalTime">00:00</b></p>
      <div style="margin-top:10px;">
        <label>ä½ çš„åå­—ï¼š <input id="playerName" placeholder="è¼¸å…¥åå­—" maxlength="20" style="padding:6px 8px;border:1px solid #ccc;border-radius:8px"/></label>
        <button id="btnSubmitScore">é€å‡ºåˆ°æ’è¡Œæ¦œ</button>
      </div>
    </div>
    <div class="dlg-actions">
      <button id="btnReplay">å†ç©ä¸€æ¬¡</button>
      <button id="btnBackToModes">å›åˆ°æ¨¡å¼é¸æ“‡</button>
    </div>
  </dialog>

  <!-- æ’è¡Œæ¦œ -->
  <dialog id="dlgBoard">
    <div class="dlg-head"><div>æ’è¡Œæ¦œï¼ˆæœ¬æ©Ÿï¼‰</div></div>
    <div class="dlg-body">
      <table id="boardTable" style="width:100%; border-collapse:collapse; font-size:14px;">
        <thead>
          <tr style="background:#f2f2f7">
            <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">#</th>
            <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">åå­—</th>
            <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">æ¨¡å¼</th>
            <th style="text-align:right; padding:8px; border-bottom:1px solid #ddd;">åˆ†æ•¸</th>
            <th style="text-align:right; padding:8px; border-bottom:1px solid #ddd;">æ™‚é–“</th>
            <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">æ—¥æœŸ</th>
          </tr>
        </thead>
        <tbody id="boardBody"></tbody>
      </table>
    </div>
    <div class="dlg-actions">
      <button id="btnClearBoard" style="color:#b00020">æ¸…é™¤æ’è¡Œæ¦œï¼ˆæœ¬æ©Ÿï¼‰</button>
      <button id="btnCloseBoard">é—œé–‰</button>
    </div>
  </dialog>

  <audio id="bgm" loop src="bgm.mp3"></audio>
  <audio id="sOk" src="correct.mp3"></audio>
  <audio id="sNg" src="wrong.mp3"></audio>

  <script>
    // ====== å¡ç‰‡æ¸…å–®ï¼ˆæ²¿ç”¨åŸæª”ï¼‰ ======
    const ALL_NOTE_IDS = [
      "ä½éŸ³è­œè™Ÿä¸‹åŠ ä¸‰é–“si","ä½éŸ³è­œè™Ÿä¸‹åŠ ä¸‰ç·šla","ä½éŸ³è­œè™Ÿä¸‹åŠ å…©é–“re","ä½éŸ³è­œè™Ÿä¸‹åŠ å…©ç·šdo",
      "é«˜éŸ³è­œè™Ÿä¸ŠåŠ ä¸‰é–“re","é«˜éŸ³è­œè™Ÿä¸ŠåŠ ä¸‰ç·šmi","é«˜éŸ³è­œè™Ÿä¸ŠåŠ å…©é–“si","é«˜éŸ³è­œè™Ÿä¸ŠåŠ å…©ç·šdo",
      "ä½éŸ³è­œè™Ÿä¸‹åŠ ä¸€é–“fa","ä½éŸ³è­œè™Ÿä¸‹åŠ ä¸€ç·šmi","ä½éŸ³è­œè™Ÿç¬¬ä¸€é–“la","ä½éŸ³è­œè™Ÿç¬¬ä¸€ç·šsol","ä½éŸ³è­œè™Ÿç¬¬äºŒç·šsi",
      "é«˜éŸ³è­œè™Ÿä¸ŠåŠ ä¸€é–“sol","é«˜éŸ³è­œè™Ÿä¸ŠåŠ ä¸€ç·šla","é«˜éŸ³è­œè™Ÿç¬¬äº”ç·šfa","é«˜éŸ³è­œè™Ÿç¬¬å››é–“mi","é«˜éŸ³è­œè™Ÿç¬¬å››ç·šre",
      "ä½éŸ³è­œè™Ÿä¸ŠåŠ ä¸€é–“si","ä½éŸ³è­œè™Ÿä¸ŠåŠ ä¸€ç·šdo","ä½éŸ³è­œè™Ÿç¬¬äºŒé–“do","ä½éŸ³è­œè™Ÿç¬¬ä¸‰é–“mi","ä½éŸ³è­œè™Ÿç¬¬ä¸‰ç·šre",
      "ä½éŸ³è­œè™Ÿç¬¬å››é–“sol","ä½éŸ³è­œè™Ÿç¬¬å››ç·šfa","ä½éŸ³è­œè™Ÿç¬¬äº”ç·šla","é«˜éŸ³è­œè™Ÿä¸‹åŠ ä¸€ç·šdo","é«˜éŸ³è­œè™Ÿä¸‹ä¸€é–“re",
      "é«˜éŸ³è­œè™Ÿç¬¬ä¸€ç·šmi","é«˜éŸ³è­œè™Ÿç¬¬ä¸€é–“fa","é«˜éŸ³è­œè™Ÿç¬¬äºŒç·šsol","é«˜éŸ³è­œè™Ÿç¬¬äºŒé–“la","é«˜éŸ³è­œè™Ÿç¬¬ä¸‰ç·šsi",
      "é«˜éŸ³è­œè™Ÿç¬¬ä¸‰é–“do"
    ];
    const ALL_CARDS = ALL_NOTE_IDS.flatMap(id => ([
      {id, type:"staff",   src:`cards/${id}äº”ç·šè­œ.png`},
      {id, type:"name",    src:`cards/${id}éŸ³å.png`},
      {id, type:"solfege", src:`cards/${id}å”±å.png`}
    ]));

    // ====== å…è¨±çš„è·¨è­œè™Ÿç­‰å€¼ï¼ˆæ²¿ç”¨åŸæª”ï¼‰ ======
    const OVERRIDES = {
      "ä½éŸ³è­œè™Ÿä¸ŠåŠ ä¸€ç·šdo": new Set(["ä½éŸ³è­œè™Ÿä¸ŠåŠ ä¸€ç·šdo","é«˜éŸ³è­œè™Ÿä¸‹åŠ ä¸€ç·šdo"]),
      "é«˜éŸ³è­œè™Ÿä¸‹åŠ ä¸€ç·šdo": new Set(["ä½éŸ³è­œè™Ÿä¸ŠåŠ ä¸€ç·šdo","é«˜éŸ³è­œè™Ÿä¸‹åŠ ä¸€ç·šdo"]),
      "é«˜éŸ³è­œè™Ÿä¸‹ä¸€é–“re": new Set(["é«˜éŸ³è­œè™Ÿä¸‹ä¸€é–“re","ä½éŸ³è­œè™Ÿç¬¬ä¸‰ç·šre"]),
      "ä½éŸ³è­œè™Ÿç¬¬ä¸‰ç·šre": new Set(["é«˜éŸ³è­œè™Ÿä¸‹ä¸€é–“re","ä½éŸ³è­œè™Ÿç¬¬ä¸‰ç·šre"]),
      "é«˜éŸ³è­œè™Ÿç¬¬ä¸€ç·šmi": new Set(["é«˜éŸ³è­œè™Ÿç¬¬ä¸€ç·šmi","ä½éŸ³è­œè™Ÿç¬¬ä¸‰é–“mi"]),
      "ä½éŸ³è­œè™Ÿç¬¬ä¸‰é–“mi": new Set(["é«˜éŸ³è­œè™Ÿç¬¬ä¸€ç·šmi","ä½éŸ³è­œè™Ÿç¬¬ä¸‰é–“mi"]),
      "é«˜éŸ³è­œè™Ÿç¬¬ä¸€é–“fa": new Set(["é«˜éŸ³è­œè™Ÿç¬¬ä¸€é–“fa","ä½éŸ³è­œè™Ÿç¬¬å››ç·šfa"]),
      "ä½éŸ³è­œè™Ÿç¬¬å››ç·šfa": new Set(["é«˜éŸ³è­œè™Ÿç¬¬ä¸€é–“fa","ä½éŸ³è­œè™Ÿç¬¬å››ç·šfa"]),
      "é«˜éŸ³è­œè™Ÿç¬¬äºŒç·šsol": new Set(["é«˜éŸ³è­œè™Ÿç¬¬äºŒç·šsol","ä½éŸ³è­œè™Ÿç¬¬å››é–“sol"]),
      "ä½éŸ³è­œè™Ÿç¬¬å››é–“sol": new Set(["é«˜éŸ³è­œè™Ÿç¬¬äºŒç·šsol","ä½éŸ³è­œè™Ÿç¬¬å››é–“sol"]),
      "é«˜éŸ³è­œè™Ÿç¬¬äºŒé–“la": new Set(["é«˜éŸ³è­œè™Ÿç¬¬äºŒé–“la","ä½éŸ³è­œè™Ÿç¬¬äº”ç·šla"]),
      "ä½éŸ³è­œè™Ÿç¬¬äº”ç·šla": new Set(["é«˜éŸ³è­œè™Ÿç¬¬äºŒé–“la","ä½éŸ³è­œè™Ÿç¬¬äº”ç·šla"]),
      "é«˜éŸ³è­œè™Ÿç¬¬ä¸‰ç·šsi": new Set(["é«˜éŸ³è­œè™Ÿç¬¬ä¸‰ç·šsi","ä½éŸ³è­œè™Ÿä¸ŠåŠ ä¸€é–“si"]),
      "ä½éŸ³è­œè™Ÿä¸ŠåŠ ä¸€é–“si": new Set(["é«˜éŸ³è­œè™Ÿç¬¬ä¸‰ç·šsi","ä½éŸ³è­œè™Ÿä¸ŠåŠ ä¸€é–“si"])
    };

    // ====== DOM ======
    const board = document.getElementById('game-board');
    const scoreEl = document.getElementById('score');
    const timeEl = document.getElementById('time');
    const toast = document.getElementById('toast');
    const titleText = document.getElementById('titleText');
    const modePill = document.getElementById('modePill');
    const bgm = document.getElementById('bgm');
    const sOk = document.getElementById('sOk');
    const sNg = document.getElementById('sNg');
    const dlg = document.getElementById('dlgHow');
    const dlgResult = document.getElementById('dlgResult');
    const finalScoreEl = document.getElementById('finalScore');
    const finalTimeEl = document.getElementById('finalTime');
    const dlgBoard = document.getElementById('dlgBoard');
    const boardBody = document.getElementById('boardBody');

    // ====== State ======
    const MODE = { EASY:'easy', HARD:'hard' };
    const GROUPS = { easy: 9, hard: 14 };
    let selectedMode = null; // å¿…é ˆå…ˆé¸æ“‡
    let currentMode = MODE.EASY;
    const state = { deck: [], open: [], score: 0, seconds: 0, timer: null, matchedTriples: 0, targetTriples: 0 };
    let nextHintAt = Date.now() + 30000;
    let hintShown = false;

    // ====== Utils ======
    function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }
    function pad2(n){ return String(n).padStart(2,'0'); }
    function fmt(sec){ const m=Math.floor(sec/60), s=Math.floor(sec%60); return pad2(m)+':'+pad2(s); }
    function tick(){ state.seconds++; timeEl.textContent = fmt(state.seconds); if(Date.now()>=nextHintAt) showHint(); }
    function startTimer(){ if(state.timer) clearInterval(state.timer); state.timer = setInterval(tick, 1000); }
    function stopTimer(){ if(state.timer) clearInterval(state.timer); state.timer = null; }

    // ====== Game build/renderï¼ˆå›ºå®š 9 æ¬„ï¼‰ ======
    function pickDeck(groups){
      const uniqueIds = Array.from(new Set(ALL_CARDS.map(c=>c.id)));
      shuffle(uniqueIds);
      const ids = uniqueIds.slice(0, groups);
      const triples = [];
      for(const id of ids){
        const staff = ALL_CARDS.find(c=>c.id===id && c.type==='staff');
        const name  = ALL_CARDS.find(c=>c.id===id && c.type==='name');
        const sol   = ALL_CARDS.find(c=>c.id===id && c.type==='solfege');
        if(staff && name && sol){ triples.push(staff, name, sol); }
      }
      return shuffle(triples);
    }

    function render(){
      board.innerHTML='';
      for(const c of state.deck){
        const d = document.createElement('div');
        d.className = 'card';
        d.dataset.idx = c.idx;
        const img = document.createElement('img');
        img.src = c.src; img.alt = c.id + ' ' + c.type;
        const badge = document.createElement('div');
        badge.className = 'badge ' + (c.type==='staff'?'staff':c.type==='name'?'name':'solfege');
        badge.textContent = c.type==='staff'?'äº”ç·šè­œ':(c.type==='name'?'éŸ³å':'å”±å');
        d.appendChild(img); d.appendChild(badge);
        d.addEventListener('click', ()=>onPick(d, c));
        board.appendChild(d);
      }
    }

    function build(){
      const groups = GROUPS[currentMode];
      const deck = pickDeck(groups);
      state.deck = deck.map((c,i)=>Object.assign({idx:i, matched:false}, c));
      state.targetTriples = groups;
      state.matchedTriples = 0;
      render();
    }

    function resetGame(){
      stopTimer();
      state.seconds = 0; timeEl.textContent = '00:00';
      state.score = 0; scoreEl.textContent = '0';
      state.open = [];
      clearHints();
      build();
      startTimer();
      bgm.currentTime = 0; bgm.play().catch(()=>{});
      scheduleHint();
    }

    // ====== Hint & validationï¼ˆä¿ç•™åŸè¦å‰‡ï¼‰ ======
    function scheduleHint(){ nextHintAt = Date.now() + 30000; hintShown = false; clearHints(); hideToast(); }
    function hideToast(){ toast.style.display='none'; }
    function showToast(){ toast.style.display='block'; setTimeout(hideToast, 2500); }
    function clearHints(){ document.querySelectorAll('.card.hint').forEach(el=> el.classList.remove('hint')); }

    function isValidTriple(a,b,c){
      const arr=[a,b,c];
      const staff = arr.find(x=>x.type==='staff');
      const labels = arr.filter(x=>x.type!=='staff');
      if(!staff || labels.length!==2) return false;
      const allow = OVERRIDES[staff.id] || new Set([staff.id]);
      return allow.has(labels[0].id) && allow.has(labels[1].id) && (labels[0].type!==labels[1].type);
    }

    function findHintTriple(){
      const unmatched = state.deck.filter(x=>!x.matched);
      const staffs = unmatched.filter(x=>x.type==='staff');
      const names = unmatched.filter(x=>x.type==='name');
      const sols  = unmatched.filter(x=>x.type==='solfege');
      for(const s of staffs){
        const allow = OVERRIDES[s.id] || new Set([s.id]);
        const n = names.find(x=> allow.has(x.id));
        const z = sols.find(x=> allow.has(x.id));
        if(n && z) return [s,n,z];
      }
      return null;
    }

    function showHint(){
      if(hintShown) return;
      const triple = findHintTriple();
      if(!triple) return;
      clearHints();
      for(const x of triple){
        const el = board.querySelector('[data-idx="'+x.idx+'"]');
        if(el) el.classList.add('hint');
      }
      showToast();
      hintShown = true;
      nextHintAt = Date.now() + 20000;
    }

    function onPick(node, card){
      scheduleHint();
      if(card.matched) return;
      if(state.open.some(o=>o.idx===card.idx)) return;
      node.classList.add('selected');
      state.open.push(card);

      if(state.open.length===3){
        const [a,b,c] = state.open;
        if(isValidTriple(a,b,c)){
          sOk.currentTime=0; sOk.play().catch(()=>{});
          state.score += 5; scoreEl.textContent = String(state.score);
          for(const x of state.open){
            x.matched = true;
            const el = board.querySelector('[data-idx="'+x.idx+'"]');
            if(el) el.classList.add('hidden');
          }
          state.matchedTriples++;
          if(state.matchedTriples >= state.targetTriples){
            stopTimer();
            finalScoreEl.textContent = state.score;
            finalTimeEl.textContent = fmt(state.seconds);
            dlgResult.showModal();
          }
        } else {
          sNg.currentTime=0; sNg.play().catch(()=>{});
          for(const x of state.open){
            const el = board.querySelector('[data-idx="'+x.idx+'"]');
            if(el) el.classList.remove('selected');
          }
        }
        state.open = [];
      }
    }

    // ====== Leaderboardï¼ˆæ²¿ç”¨åŸæœ¬æœ¬æ©Ÿå„²å­˜ï¼‰ ======
    function loadBoard(){
      try { return JSON.parse(localStorage.getItem('noteGameBoard')||'[]'); } catch(e){ return []; }
    }
    function saveBoard(rows){ localStorage.setItem('noteGameBoard', JSON.stringify(rows)); }
    function pushBoard(row){
      const rows = loadBoard();
      rows.push(row);
      rows.sort((a,b)=> (b.score - a.score) || (a.seconds - b.seconds) || (b.ts - a.ts) );
      saveBoard(rows.slice(0,50));
    }
    function renderBoard(){
      const rows = loadBoard();
      boardBody.innerHTML = '';
      rows.forEach((r, i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="padding:6px;border-bottom:1px solid #eee;">${i+1}</td>
          <td style="padding:6px;border-bottom:1px solid #eee;">${r.name||'â€”'}</td>
          <td style="padding:6px;border-bottom:1px solid #eee;">${r.mode==='easy'?'ç°¡å–®':'å›°é›£'}</td>
          <td style="padding:6px;border-bottom:1px solid #eee; text-align:right;">${r.score}</td>
          <td style="padding:6px;border-bottom:1px solid #eee; text-align:right;">${fmt(r.seconds)}</td>
          <td style="padding:6px;border-bottom:1px solid #eee;">${new Date(r.ts).toLocaleString()}</td>`;
        boardBody.appendChild(tr);
      });
    }

    // ====== Controls ======
    document.getElementById('btnRestart').addEventListener('click', resetGame);
    document.getElementById('volBgm').addEventListener('input', e=> bgm.volume = e.target.value);
    document.getElementById('volOk').addEventListener('input', e=> sOk.volume = e.target.value);
    document.getElementById('volNg').addEventListener('input', e=> sNg.volume = e.target.value);
    document.getElementById('btnLeaderboard').addEventListener('click', ()=>{ renderBoard(); dlgBoard.showModal(); });
    document.getElementById('btnCloseBoard').addEventListener('click', ()=> dlgBoard.close());
    document.getElementById('btnClearBoard').addEventListener('click', ()=>{ if(confirm('ç¢ºå®šæ¸…é™¤æœ¬æ©Ÿæ’è¡Œæ¦œï¼Ÿ')){ saveBoard([]); renderBoard(); } });

    // ====== How-to & start flow ======
    const selectStatus = document.getElementById('selectStatus');
    const modeButtons = { easy: document.getElementById('startEasy'), hard: document.getElementById('startHard') };
    modeButtons.easy.addEventListener('click', ()=> chooseMode('easy'));
    modeButtons.hard.addEventListener('click', ()=> chooseMode('hard'));
    function chooseMode(m){
      selectedMode = m;
      modeButtons.easy.classList.toggle('active', m==='easy');
      modeButtons.hard.classList.toggle('active', m==='hard');
      selectStatus.style.display='block';
      selectStatus.textContent = m==='easy' ? 'å·²é¸æ“‡ï¼šç°¡å–®ç‰ˆï¼ˆ9 çµ„ / 27 å¼µå¡ç‰Œï¼‰' : 'å·²é¸æ“‡ï¼šå›°é›£ç‰ˆï¼ˆ14 çµ„ / 42 å¼µå¡ç‰Œï¼‰';
      document.getElementById('dlgStartClose').disabled = false;
    }
    document.getElementById('btnHowTo').addEventListener('click', ()=> dlg.showModal());
    document.getElementById('dlgStartClose').addEventListener('click', ()=> {
      setMode(selectedMode||'easy');
      dlg.close();
      resetGame(); // ç›´æ¥é–‹å§‹éŠæˆ²
    });

    // ====== Result dialog buttons ======
    document.getElementById('btnReplay').addEventListener('click', ()=>{ dlgResult.close(); resetGame(); });
    document.getElementById('btnBackToModes').addEventListener('click', ()=>{
      dlgResult.close();
      selectedMode=null;
      modeButtons.easy.classList.remove('active'); modeButtons.hard.classList.remove('active');
      selectStatus.style.display='none'; document.getElementById('dlgStartClose').disabled=true;
      dlg.showModal();
    });
    document.getElementById('btnSubmitScore').addEventListener('click', ()=>{
      const name = document.getElementById('playerName').value.trim() || 'Player';
      const row = { name, mode: currentMode, score: state.score, seconds: state.seconds, ts: Date.now() };
      pushBoard(row);
      document.getElementById('playerName').value='';
      dlgResult.close();
      renderBoard();
      dlgBoard.showModal();
    });

    function setMode(m){
      if(m==='easy'){ currentMode='easy'; titleText.textContent='éŸ³ç¬¦æ¶ˆæ¶ˆæ¨‚ï¼ˆç°¡å–®ç‰ˆï¼‰'; modePill.textContent='ç°¡å–®'; }
      else { currentMode='hard'; titleText.textContent='éŸ³ç¬¦æ¶ˆæ¶ˆæ¨‚ï¼ˆå›°é›£ç‰ˆï¼‰'; modePill.textContent='å›°é›£'; }
    }

    // åˆæ¬¡è¼‰å…¥ â†’ é¡¯ç¤ºè§£èªªèˆ‡æ¨¡å¼é¸æ“‡
    dlg.showModal();
  </script>
</body>
</html>
